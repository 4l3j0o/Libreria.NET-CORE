@using Library.ViewModels
@{
    var currentPath = Context.Request.Path.Value ?? string.Empty;
}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Sistema de Gestión de Biblioteca UPDS</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/LibraryManagementSystem.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/lib/bootstrap-icon/font/bootstrap-icons.css" />
</head>

<body>
    <style>
        #wrapper {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        #sidebar-wrapper {
            width: 250px;
            min-height: 100vh;
            transition: all 0.3s;
        }

        #sidebar-wrapper.collapsed {
            width: 70px;
        }

        #page-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-heading {
            padding: 1rem;
            font-size: 1.2rem;
        }

        .collapse:not(.show) {
            display: none;
        }

        .collapse.show {
            display: block;
        }

        .navbar-brand img {
            max-height: 40px;
        }

        .navbar-brand span {
            line-height: 1.2;
        }

        .hover-bg:hover {
            background-color: #f0f0f0;
            /* light grey hover background */
            transition: background-color 0.2s ease;
        }

        .nav-link {
            color: #06035C !important;
            /* Bootstrap text-dark */
        }

        .nav-link.active,
        .nav-link:focus,
        .nav-link:hover {
            color: #15151D !important;
            /* Bootstrap primary */
            font-weight: 600;
        }

        .dropdown-menu {
            border-radius: 0.5rem;
            min-width: 180px;
        }
    </style>

    <nav class="navbar navbar-expand-sm navbar-light bg-info border-bottom shadow">
        <div class="container-fluid">
            @if (User.IsInRole("Admin"))
            {
                <button class="btn btn-outline-primary me-3" id="menu-toggle">☰</button>
            }
            <a class="navbar-brand d-flex align-items-center gap-2" asp-area="" asp-controller="Home"
                asp-action="Index">
                <img src="~/Images/Urban_Council_Gampola_Logo.png" height="40" class="me-2" alt="Library Logo" />
                <div class="d-flex flex-column lh-sm">
                    <span class="fw-bold fs-5 text-dark">Libreria</span>
                    @* <span class="fs-6 text-muted">Gampola</span> *@
                </div>
            </a>

            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto align-items-center gap-2">
                    <li class="nav-item">
                        <a class="nav-link fw-semibold px-3 py-2 rounded hover-bg" asp-area="" asp-controller="Home"
                            asp-action="Index">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link fw-semibold px-3 py-2 rounded hover-bg" asp-area="" asp-controller="About"
                            asp-action="Index">Sobre Nosotros</a>
                    </li>

                    @if (User.IsInRole("Member"))
                    {

                        <li class="nav-item dropdown hover-dropdown">
                            <a class="nav-link dropdown-toggle fw-semibold px-3 py-2 rounded hover-bg no-caret text-dark"
                                href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Colecciones</a>
                            <ul class="dropdown-menu" aria-labelledby="collectiondropdown">
                                <li><a class="dropdown-item" asp-area="member" asp-controller="Book"
                                        asp-action="Index">Libros</a></li>
                                <li><a class="dropdown-item" asp-area="member" asp-controller="Newspaper"
                                        asp-action="Index">Periódicos</a></li>
                                <li><a class="dropdown-item" asp-area="member" asp-controller="Journal"
                                        asp-action="Index">Revistas</a></li>
                                <li><a class="dropdown-item" asp-area="member" asp-controller="Periodical"
                                        asp-action="Index">Publicaciones Periódicas</a></li>
                            </ul>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link fw-semibold px-3 py-2 rounded hover-bg me-5" asp-area="member"
                                asp-controller="Event" asp-action="Index">Eventos de la Biblioteca</a>
                        </li>

                    }

                </ul>
                @* <ul> *@
                @*     @if (User.IsInRole("Member")) *@
                @*     { *@
                @*         <li class="nav-item dropdown" id="notificationDropdown"> *@
                @*             <a href="#" class="nav-link" id="notificationIcon" data-bs-toggle="dropdown"> *@
                @*                 <i class="bi bi-bell"></i> *@
                @*                 <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationCount"> *@
                @*                     <!-- Optional: count --> *@
                @*                 </span> *@
                @*             </a> *@
                @*             <div id="notificationContent"></div> *@
                @*         </li> *@
                @*     } *@
                @* </ul> *@
                <partial name="_LoginPartial" />
            </div>

        </div>
    </nav>



    <div id="wrapper">
        @if (currentPath.StartsWith("/admin", StringComparison.OrdinalIgnoreCase))
        {
            <div class="bg-light border-end" id="sidebar-wrapper">
                <div class="sidebar-heading bg-info text-white">Admin Panel</div>
                <ul class="nav flex-column p-2">
                    <li class="nav-item">
                        <a class="nav-link text-dark me-5" asp-area="admin" asp-controller="Dashboard"
                            asp-action="Index">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark" data-bs-toggle="collapse" href="#collapseCollections" role="button"
                            aria-expanded="false" aria-controls="collapseCollections">
                            Collections
                        </a>
                        <div class="collapse" id="collapseCollections">
                            <ul class="nav flex-column ms-3">
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Book"
                                        asp-action="Index">Libros</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Newspaper"
                                        asp-action="Index">Periódicos</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Journal"
                                        asp-action="Index">Revistas</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Periodical"
                                        asp-action="Index">Publicaciones Periódicas</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark me-4" asp-area="admin" asp-controller="Borrowing"
                            asp-action="Index">Préstamos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark me-4" asp-area="admin" asp-controller="Event"
                            asp-action="Index">Eventos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark" data-bs-toggle="collapse" href="#collapseUserMgmt" role="button"
                            aria-expanded="false" aria-controls="collapseUserMgmt">
                            Informes
                        </a>
                        <div class="collapse" id="collapseUserMgmt">
                            <ul class="nav flex-column ms-3">
                                <li><a class="nav-link text-dark me-4" asp-area="admin" asp-controller="Report"
                                        asp-action="Index">Conteo de Ítems de Biblioteca por Categoría</a></li>
                                <li><a class="nav-link text-dark me-4" asp-area="admin" asp-controller="Report"
                                        asp-action="MemberRegistrationReport">Conteo de Miembros por Evento</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark me-5" asp-area="admin" asp-controller="User"
                            asp-action="Index">Administración de Usuarios</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-dark" data-bs-toggle="collapse" href="#collapseAdminSettings" role="button"
                            aria-expanded="false" aria-controls="collapseAdminSettings">
                            Configuración de Administrador
                        </a>
                        <div class="collapse" id="collapseAdminSettings">
                            <ul class="nav flex-column ms-3">
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Library"
                                        asp-action="Index">Información de la Biblioteca</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Language"
                                        asp-action="Index">Idiomas de los Catálogos</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Category"
                                        asp-action="Index">Categorías</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Publisher"
                                        asp-action="Index">Editoriales</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Genre"
                                        asp-action="Index">Géneros</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Country"
                                        asp-action="Index">Países</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="Author"
                                        asp-action="Index">Autores</a></li>
                                <li><a class="nav-link text-dark" asp-area="admin" asp-controller="FieldOfStudy"
                                        asp-action="Index">Áreas de Estudio - Revistas</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
        }

        <div id="page-content-wrapper">
            <main role="main">
                @RenderBody()
            </main>
        </div>

        <footer class="border-top footer text-muted mt-5">
            <div class="container">
                &copy; 2025 - Sistema de Gestión de Biblioteca
            </div>
        </footer>

    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/link-loader.js" defer></script>
    <script src="~/js/link-loader.js"></script>
    <script src="~/lib/chartjs/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @await RenderSectionAsync("Scripts", required: false)


    @Html.Partial("_DeleteModal")
    @Html.Partial("_InfoModal")
    @Html.Partial("_SuccessModel")

    <script>
        const collapses = document.querySelectorAll("#sidebar-wrapper .collapse");
        collapses.forEach(function (el) {
            el.addEventListener("show.bs.collapse", function () {
                document.getElementById("sidebar-wrapper")?.classList.remove("collapsed");
            });
        });
    </script>

    <script>
        document.getElementById("menu-toggle")?.addEventListener("click", function (e) {
            e.preventDefault();
            document.getElementById("wrapper").classList.toggle("toggled");
        });
    </script>

    <script>
        let selectedId = 0;
        let selectedName = "";
        let currentController = "";

        function openDeleteModal(Id, Name, Controller) {
            selectedId = Id;
            selectedName = Name;
            currentController = Controller;
            document.getElementById("confirmDeleteText").textContent = `Are you sure you want to delete "${Name}"?`;
            const confirmModal = new bootstrap.Modal(document.getElementById("confirmDeleteModal"));
            confirmModal.show();
        }

        document.getElementById("confirmYesBtn").addEventListener("click", function () {
            fetch(`${window.location.origin}/Admin/${currentController}/Delete/${selectedId}`, {
                method: "POST"
            }).then(response => {
                if (response.ok) {
                    const confirmModalEl = document.getElementById("confirmDeleteModal");
                    const confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
                    confirmModal.hide();

                    document.getElementById("successMessage").textContent = ` "${selectedName}" deleted successfully.`;
                    const successModald = new bootstrap.Modal(document.getElementById("successModald"));
                    successModald.show();
                }
            });
        });

        document.getElementById("successOkBtn").addEventListener("click", function () {
            const successModald = bootstrap.Modal.getInstance(document.getElementById("successModald"));
            successModald.hide();
            location.reload(); // or redirect as needed
        });
    </script>

    <script>
        window.onload = function () {
            var message = '@TempData["SuccessMessage"]';
            if (message) {
                document.getElementById("successText").innerText = message;

                var successModal = new bootstrap.Modal(document.getElementById('successModal'));
                successModal.show();
            }
        };

        function clearForm() {
            document.querySelector("form").reset();
        }
    </script>

    <script>
        window.onload = function () {
            const successMessage = '@TempData["SuccessMessage"]';
            const errorMessage = '@TempData["ErrorMessage"]';

            if (successMessage) {
                document.getElementById("infoText").innerText = successMessage;
                new bootstrap.Modal(document.getElementById("infoModal")).show();
            } else if (errorMessage) {
                document.getElementById("infoText").innerText = errorMessage;
                new bootstrap.Modal(document.getElementById("infoModal")).show();
            }
        };
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const icon = document.getElementById("notificationIcon");
            const content = document.getElementById("notificationContent");

            icon.addEventListener("click", function (e) {
                e.preventDefault();

                fetch('/Notification/GetUserNotifications')
                    .then(response => response.text())
                    .then(html => {
                        content.innerHTML = html;
                    })
                    .catch(error => console.error("Error loading notifications:", error));
            });
        });
    </script>


</body>

</html>
